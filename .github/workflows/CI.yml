name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    env:
      SONAR_ORG: "cecile-umecker"
      SONAR_PROJECT_KEY_BACK: "cecile-umecker_Gerez-un-projet-collaboratif-en-int-grant-une-demarche-CI-CD-backend"
      SONAR_PROJECT_KEY_FRONT: "cecile-umecker_Gerez-un-projet-collaboratif-en-int-grant-une-demarche-CI-CD-frontend"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Backend
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Back - Build & Run Tests
        run: |
          cd back
          mvn clean verify

      - name: Back - Generate Coverage Report
        run: |
          cd back
          mvn jacoco:report

      - name: Back - Check Coverage Threshold (80%)
        run: |
          cd back
          COVERAGE=$(awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print int(100*covered/instructions) }' target/site/jacoco/jacoco.csv)
          echo "Backend coverage: $COVERAGE%"
          if [ "$COVERAGE" -lt 80 ]; then
            echo "Error: Coverage is below 80% threshold"
            exit 1
          fi

      - name: Set up JDK 17 (pour Sonar Scanner)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Back - SonarCloud Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd back
          mvn sonar:sonar \
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY_BACK }} \
            -Dsonar.organization=${{ env.SONAR_ORG }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

      - name: Back - Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: back/target/site/jacoco/

      # Frontend
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16.x'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json

      - name: Install dependencies
        run: |
          cd front
          npm ci

      - name: Front - Run Tests & Generate Coverage
        run: |
          cd front
          npx ng test --watch=false --browsers=ChromeHeadless --code-coverage

      - name: Front - Check Coverage Threshold (80%)
        run: |
          cd front
          COVERAGE=$(grep -oP '(?<=Lines\s+:\s)\d+(?=\.\d+%)' coverage/bobapp/index.html | head -1)
          echo "Frontend coverage: $COVERAGE%"
          if [ "$COVERAGE" -lt 80 ]; then
            echo "Error: Coverage is below 80% threshold"
            exit 1
          fi

      - name: Front - SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: front
          args: >
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY_FRONT }}
            -Dsonar.organization=${{ env.SONAR_ORG }}
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.spec.ts
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      - name: Front - Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: front/coverage/